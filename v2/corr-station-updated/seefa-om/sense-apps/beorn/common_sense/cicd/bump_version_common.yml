.install_deps: &install_deps
    - apk add python3
    - apk add py3-pip
    - apk add git
    - pip3 install --upgrade pip
    - pip3 install Commitizen

.git_setup: &git_setup
    - git remote set-url origin $repo_url
    - git config --global user.email "${CI_EMAIL}" && git config --global user.name "${CI_USERNAME}"

.clone_repo: &clone_repo
    - mkdir /clone
    - git clone $repo_url /clone
    - cd /clone
    - git clone -b master --recurse-submodules https://ci-user:$SEA_GITLAB_ACCESS_TOKEN@$CI_SERVER_HOST/service-engineering-automation/sense/common_sense.git

.develop_version_push: &develop_version_push
    - git checkout develop
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/VERSION .
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/CHANGELOG.md .
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/.cz.yaml .
    - >
      git commit -m "ci: version control update [skip-ci]" VERSION CHANGELOG.md .cz.yaml
    - git push origin develop

.master_version_push: &master_version_push
    - git checkout master
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/VERSION .
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/CHANGELOG.md .
    - cp /builds/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/.cz.yaml .
    - >
      git commit -m "ci: version control update [skip-ci]" VERSION CHANGELOG.md .cz.yaml
    - >
      git push origin master -o merge_request.create -o merge_request.target=develop -o merge_request.title="ci: Auto MR Master to Dev" -o merge_request.description="ci: Branch Sync-Up Merge Request for versioning and hotfixes" -o ci.skip

.tagging: &tagging
    - TAG=$(cat VERSION).$CI_COMMIT_SHORT_SHA
    - git tag -a "$TAG" -m "Auto tag for $CI_COMMIT_REF_NAME - version $TAG"
    - git push origin $TAG -o ci.skip

.bump_version: &bump_version
  variables:
    repo_url: https://ci-user:$SEA_GITLAB_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME.git
  before_script:
    - *install_deps
    - *git_setup
    - cz --no-raise 3,7,21 bump --yes
    - *clone_repo
    - *master_version_push
    - *tagging
