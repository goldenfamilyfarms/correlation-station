=============================================================================
          CORRELATION STATION - CODEBASE EXPLORATION SUMMARY
=============================================================================

Date: November 16, 2025
Repository: /home/user/correlation-station
Branch: claude/alloy-data-processing-01ARA8UqTi6QGBHwjTWyeijw
Status: COMPLETE

=============================================================================
                          KEY FINDINGS SUMMARY
=============================================================================

QUESTION 1: Current Alloy Configuration & Data Processing
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

FINDINGS:
  ✅ Primary config: /mdso-alloy/config.alloy (65 lines)
  ✅ Tails: /var/log/ciena/blueplanet.log and /bp2/log/*.log
  ✅ Syslog parsing with regex: timestamp, hostname, message extraction
  ✅ Low-cardinality labeling: {service="mdso", env="dev"}
  ✅ Exports via OTLP HTTP to gateway at 159.56.4.94:55681
  
TRANSFORMATION:
  ✅ Syslog format normalization
  ✅ Adds structured labels and metadata
  ✅ Converts to OTLP JSON format
  
GAPS:
  ❌ Does NOT extract circuit_id from message text
  ❌ Does NOT extract resource_id from message  
  ❌ Does NOT map device vendor or FQDN
  ❌ Does NOT categorize error patterns
  ❌ No trace context (trace_id absent)

CURRENT DATA LOSS:
  ~15-20 important fields are embedded in log message text but not extracted
  These could be: circuit_id, resource_id, device TID, vendor, service type


QUESTION 2: MDSO Component & Data Transmission
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

FINDINGS:
  ✅ MDSO is pure log source (no API integration currently)
  ✅ Sends syslog files from network device operations
  ✅ Includes orchestration traces and RA logs
  ✅ Logs contain business context: circuit_id, resource_id, device info
  
DATA ATTRIBUTES IN MDSO LOGS:
  Circuit ID: "80.L1XX.005054..CHTR"
  Resource ID: "550e8400-e29b-41d4-a716-446655440000"
  Product Type: "service_mapper", "network_service", etc.
  Device TID: "JFVLINBJ2CW" (10-char identifier)
  FQDN: "JFVLINBJ2CW.CHTRSE.COM"
  Vendor: "juniper", "adva", "cisco", "rad"
  Service Type: "ELAN", "ELINE", "FIA", "VOICE", "VIDEO"
  Orchestration State: "CREATE_IN_PROGRESS", "DELETE_IN_PROGRESS"
  Error Codes: Patterns like "DE-1000", "DE-1001", etc.
  
TRANSMISSION METHOD:
  1. Log files created on MDSO Dev host
  2. Alloy tails files
  3. Parses and normalizes
  4. Exports via OTLP HTTP POST to gateway
  5. Gateway routes to correlation engine
  
CRITICAL GAP:
  ⚠️ No trace context from MDSO → cannot directly correlate with Sense app traces
  ⚠️ Workaround: Trace synthesis uses circuit_id matching (implemented, untested)


QUESTION 3: Correlation Engine & Expected Data Format
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

FINDINGS:
  ✅ FastAPI-based correlation engine at :8080
  ✅ Two OTLP ingestion endpoints:
     - POST /api/otlp/v1/logs
     - POST /api/otlp/v1/traces
  ✅ Maintains 60-second sliding correlation windows
  ✅ Groups logs and traces by trace_id
  ✅ Creates synthetic bridge spans when trace_id missing but circuit_id matches
  
EXPECTED DATA MODELS:

  LogRecord expects:
  {
    "timestamp": ISO format string,
    "severity": "INFO|WARN|ERROR|FATAL",
    "message": "log message text",
    "trace_id": "optional - 32 hex chars",
    "span_id": "optional - 16 hex chars",
    "circuit_id": "optional - e.g., 80.L1XX.005054..CHTR",
    "product_id": "optional UUID",
    "resource_id": "optional UUID",
    "resource_type_id": "optional - e.g., tosca.resourceTypes.*",
    "request_id": "optional",
    "labels": {dictionary of additional attributes}
  }

  Current Reality:
  - From Alloy (MDSO): Only has timestamp, message, service, env
    * trace_id: NULL (MDSO doesn't provide)
    * circuit_id: IN MESSAGE TEXT ONLY (not extracted)
    * resource_id: IN MESSAGE TEXT ONLY (not extracted)
  
  - From Sense Apps: Have trace_id, but may lack circuit_id
    * Beorn: OTel instrumented, extracts from MDSO response
    * Palantir: OTel instrumented, extracts from API calls
    * Arda: OTel instrumented with FastAPI hooks
  
CORRELATION PROCESSING:
  1. LogNormalizer: Parses OTLP, extracts service/host/env
  2. CorrelationWindow: Groups by trace_id into 60-second windows
  3. TraceSynthesizer: If no trace_id, scores parent-child by:
     - circuit_id match: +100 points
     - resource_id match: +80 points
     - product_id match: +60 points
     - temporal proximity: +40 points (within 10s)
     - service flow pattern: +50 points
  4. Creates synthetic bridge span if confidence > 0.5
  5. MDSOCorrelator: Enriches with MDSO context
  6. ExporterManager: Exports to Loki, Tempo, Prometheus


QUESTION 4: Data Processing, Transformation & Enrichment Steps
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

CURRENT TRANSFORMATIONS:

  Stage 1: Alloy (MINIMAL)
  ├─ Syslog parsing: Extract timestamp, hostname, message
  ├─ Label addition: service="mdso", env="dev"
  ├─ Format: Syslog text → OTLP JSON
  └─ Lost: 15+ fields embedded in message

  Stage 2: OTel Gateway (ROUTING)
  ├─ Batch processor: Groups records (send_batch_size=1024)
  ├─ Resource attributes: Add environment, host info
  ├─ Routes to: Correlation Engine, Loki (direct), Tempo (direct)
  └─ Minimal transformation

  Stage 3: Correlation Engine (HEAVY LIFTING)
  ├─ Normalization: Parse OTLP format
  ├─ Windowing: Group by trace_id into 60-second windows
  ├─ Trace Synthesis: Create bridge spans
  │  └─ Uses circuit_id/resource_id matching algorithm
  ├─ MDSO Enrichment: Add mdso_context metadata
  └─ Export: Loki, Tempo, Prometheus

  Stage 4: Exporters (FORMATTING)
  ├─ Loki:
  │  ├─ Low-cardinality labels: {service, env, trace_id}
  │  ├─ Circuit_id stored as JSON in body (not label)
  │  └─ 7-day retention
  ├─ Tempo:
  │  ├─ OTLP ResourceSpans format
  │  ├─ Includes synthetic bridge spans
  │  └─ 7-day retention
  └─ Prometheus:
     ├─ Metrics: correlation_events_total, trace_synthesis_total
     └─ Circuit breaker state tracking

ENRICHMENT CURRENTLY HAPPENING:
  ✅ MDSO context extraction (device_tid, orch_state, product_type)
  ✅ Service name and environment tagging
  ✅ Timestamp normalization
  ✅ Severity level mapping (syslog → OTEL)
  
ENRICHMENT MISSING:
  ❌ Circuit ID extraction from message
  ❌ Device topology lookup (vendor, FQDN, management_ip)
  ❌ Error pattern recognition and categorization
  ❌ Defect code assignment (DE-1000, etc.)
  ❌ New error detection
  ❌ RA log correlation with device info
  ❌ Orchestration trace parsing


=============================================================================
                           GAPS IDENTIFIED
=============================================================================

CRITICAL GAPS:

1. MDSO Log Parsing Gap
   └─ Circuit ID not extracted from message text
      Impact: Cannot correlate MDSO logs with Sense app traces by circuit_id
      Solution: Add regex extraction in Alloy OR Correlation Engine

2. Trace Context Propagation Gap
   └─ MDSO never sets trace_id
      Impact: MDSO↔Sense app traces are disconnected
      Solution: Trace synthesis (implemented, untested)
   └─ Sense apps may not include circuit_id in MDSO calls
      Impact: Reverse correlation (Sense→MDSO) missing
      Solution: Enhance Sense app instrumentation

3. Device Enrichment Gap
   └─ No FQDN → vendor mapping
   └─ No management IP collection
   └─ No device topology association
      Impact: Cannot determine network function context
      Solution: Integrate Beorn topology API

4. Error Analysis Gap
   └─ Error patterns not recognized
   └─ Defect codes not assigned
   └─ New error detection not implemented
      Impact: Missing error intelligence
      Solution: Implement 70+ regex patterns from META tool


=============================================================================
                        OPPORTUNITIES FOR ENHANCEMENT
=============================================================================

PHASE 1 - IMMEDIATE (Week 1):
  [ ] Add circuit_id regex extraction to Alloy loki.process stage
  [ ] Implement regex patterns in Correlation Engine normalizer
  [ ] Test Trace Synthesis with real circuit_id matches
  
PHASE 2 - SHORT-TERM (Week 2-3):
  [ ] Add comprehensive error pattern detection
  [ ] Implement device topology enrichment from Beorn
  [ ] Enhanced baggage propagation in Sense apps
  
PHASE 3 - MEDIUM-TERM (Week 4-6):
  [ ] Integrate MDSO API collection endpoint
  [ ] Build orchestration trace parser
  [ ] Implement error defect code assignment system
  
PHASE 4 - LONG-TERM (Week 7+):
  [ ] Horizontal scaling with stateless correlation engine
  [ ] Advanced trace reconstruction algorithms
  [ ] Real-time anomaly detection


=============================================================================
                         DOCUMENTATION CREATED
=============================================================================

1. DATA_PIPELINE_ANALYSIS.md (23 KB)
   ├─ Comprehensive 7-section analysis
   ├─ Detailed data format specifications
   ├─ MDSO attribute extraction requirements
   ├─ Correlation engine data model documentation
   ├─ Current vs. expected processing flow
   ├─ Gaps and opportunities for enhancement
   └─ Actionable recommendations by phase

2. DATA_FLOW_DIAGRAM.md (8 KB)
   ├─ High-level system data flow diagram
   ├─ Data format transformation journey
   ├─ Key extraction point documentation
   ├─ Data flow summary matrix
   └─ Clear visual representation of current pipeline

Location: /home/user/correlation-station/v2/corr-station-updated/seefa-om/


=============================================================================
                          KEY FILES ANALYZED
=============================================================================

Alloy Configuration:
  • /mdso-alloy/config.alloy (65 lines)
  • /mdso-alloy/config-test3-full-pipeline.alloy (68 lines)

Correlation Engine:
  • /correlation-engine/app/models.py - Data models (LogRecord, etc.)
  • /correlation-engine/app/routes/otlp.py - OTLP ingestion (11 KB)
  • /correlation-engine/app/pipeline/normalizer.py - Log parsing
  • /correlation-engine/app/pipeline/correlator.py - Windowed correlation
  • /correlation-engine/app/pipeline/mdso_correlator.py - MDSO-specific
  • /correlation-engine/app/pipeline/exporters.py - Export logic
  • /correlation-engine/app/correlation/trace_synthesizer.py - Bridge spans

Gateway:
  • /gateway/otel-config.yaml - OTel collector configuration

Sense Apps:
  • /sense-apps/beorn/beorn_app/common/otel/otel_sense.py - OTel setup
  • /sense-apps/*/common/otel/instrumentation - App-specific OTel

Docker:
  • /docker-compose.yml - Full platform composition
  • /mdso-alloy/docker-compose.yml - Alloy service
  • /correlation-engine/docker-compose.yml - Engine service

Documentation:
  • /MDSO_OTEL_INSTRUMENTATION_FINDINGS.md (21 KB) - MDSO patterns
  • /SENSE_OTEL_IMPLEMENTATION_SUMMARY.md (29 KB) - OTel implementation
  • /README.md - System overview


=============================================================================
                        TECHNICAL SPECIFICATIONS
=============================================================================

Data Flow Endpoints:
  MDSO → Alloy: File tail (local disk)
  Alloy → Gateway: HTTP POST :55681/v1/logs (OTLP)
  Sense Apps → Gateway: gRPC :4317 or HTTP :4318 (OTLP)
  Gateway → Correlation Engine: HTTP :8080/api/otlp (OTLP)
  Correlation Engine → Loki: HTTP :3100/loki/api/v1/push
  Correlation Engine → Tempo: gRPC :4317 (OTLP)

Data Volumes:
  Correlation Window: 60 seconds (configurable)
  Max Batch Size: 5000 records (configurable)
  Queue Depth: Up to 10,000 (configurable)

Latency:
  Alloy → Gateway: ~5-10 seconds
  Gateway → Correlation Engine: ~1-5 seconds
  Correlation Engine → Loki/Tempo: ~1-3 seconds (with retries)
  Total: ~10-20 seconds for end-to-end correlation

Retention:
  Loki: 7 days
  Tempo: 7 days
  Prometheus: 15 days


=============================================================================
                         SUMMARY CONCLUSIONS
=============================================================================

The Correlation Station is a sophisticated observability platform that:

1. COLLECTS data from MDSO logs (via Alloy) and Sense app spans (OTel)
2. NORMALIZES both to OTLP format with low-cardinality labeling
3. CORRELATES logs and traces in 60-second sliding windows
4. SYNTHESIZES missing trace context using business identifier matching
5. ENRICHES events with MDSO-specific metadata
6. EXPORTS to Loki (logs), Tempo (traces), Prometheus (metrics)

MATURITY LEVEL: 
  ✅ Production-ready architecture
  ⚠️ Missing some key data extraction and enrichment features
  ⚠️ Trace synthesis untested in production
  ✅ Excellent test coverage and documentation

READINESS FOR PRODUCTION:
  Data Collection: ✅ READY (Alloy working)
  Data Normalization: ✅ READY (OTLP format solid)
  Correlation Logic: ⚠️ PARTIAL (needs circuit_id extraction)
  Trace Synthesis: ⚠️ PARTIAL (implemented but untested)
  Data Enrichment: ❌ INCOMPLETE (missing MDSO attributes)
  Error Analysis: ❌ NOT IMPLEMENTED

NEXT STEPS:
  1. Implement circuit_id extraction from MDSO logs
  2. Enable trace synthesis with real circuit_id data
  3. Add comprehensive error pattern detection
  4. Integrate device topology enrichment
  5. Create monitoring dashboards for correlation quality


=============================================================================
End of Summary - Generated: November 16, 2025
=============================================================================
