variables:
  GIT_SUBMODULE_STRATEGY: normal

.env_setup_dev: &env_setup_dev
    - export BEORN_HYDRA_KEY=$BEORN_HYDRA_KEY_DEV
    - export BEORN_HYDRA_KEY_SKELLY=$BEORN_HYDRA_KEY_DEV_SKELLY
    - export PALANTIR_GENERAL_HYDRA_KEY=$PALANTIR_GENERAL_HYDRA_KEY_DEV
    - export PALANTIR_GENERAL_HYDRA_KEY_SKELLY=$PALANTIR_GENERAL_HYDRA_KEY_DEV_SKELLY
    - export PALANTIR_SPIRENT_HYDRA_KEY=$PALANTIR_SPIRENT_HYDRA_KEY_DEV
    - export PALANTIR_SPIRENT_HYDRA_KEY_SKELLY=$PALANTIR_SPIRENT_HYDRA_KEY_DEV_SKELLY
    - export MDSO_PASS=$MDSO_PASS_PROD
    - export MDSO_PASS_SKELLY=$MDSO_PASS_PROD_SKELLY
    - export GRANITE_BASE_URL=$GRANITE_BASE_URL_DEV
    - export ARIN_CREATE_BASE_URL=$ARIN_CREATE_BASE_URL_DEV
    - export SENSE_BASE_URL=$SENSE_BASE_URL_DEV
    - export WHOIS_BASE_URL=$WHOIS_BASE_URL_DEV
    - export REMEDY_BASE_URL=$REMEDY_BASE_URL_DEV
    - export REMEDY_PASS=$REMEDY_PASS_DEV
    - export REMEDY_PASS_SKELLY=$REMEDY_PASS_DEV_SKELLY
    - export REMEDY_SERVER=$REMEDY_SERVER_DEV
    - export REMEDY_USER=$REMEDY_USER_DEV
    - export USAGE_DESIGNATION=$USAGE_DESIGNATION_DEV

.pytest_template: &pytest_template
  before_script:
    - pip3 install --upgrade pip
    - pip3 install -r requirements.txt
    - *env_setup_dev  
  script:
    - pytest -m "unittest" --cov=palantir_app --cov-report xml --cov-report=term-missing --junitxml=test.xml tests

test:
  stage: test
  tags:
    - test
  <<: *pytest_template
  except:
    - master
    - develop

test_with_coverage:
  stage: test_with_coverage
  tags:
    - test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  <<: *pytest_template
  artifacts:
    paths:
      - /builds/service-engineering-automation/sense/palantir/test.xml
      - /builds/service-engineering-automation/sense/palantir/coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: /builds/service-engineering-automation/sense/palantir/coverage.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
