# Unified Docker Compose for SENSE Apps
# Deploy all three SENSE microservices together
#
# Usage:
#   docker-compose up -d           # Start all services
#   docker-compose up -d arda      # Start only Arda
#   docker-compose logs -f beorn   # View Beorn logs
#   docker-compose down            # Stop all services

version: '3.8'

networks:
  sense-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
  # Connect to observability stack
  observability:
    external: true
    name: observability

services:
  # ============================================
  # Arda - Inventory SEEFA Design Service
  # ============================================
  arda:
    build:
      context: ./arda
      dockerfile: Dockerfile
    container_name: arda-fastapi
    restart: unless-stopped
    ports:
      - "5001:5001"
    environment:
      # OpenTelemetry Configuration
      OTEL_SERVICE_NAME: arda
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:-production}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://159.56.4.94:4318
      OTEL_EXPORTER_OTLP_PROTOCOL: http/protobuf
      OTEL_TRACES_SAMPLER: parentbased_traceidratio
      OTEL_TRACES_SAMPLER_ARG: "0.1"
      # DataDog (optional dual export)
      DD_AGENT_HOST: ${DD_AGENT_HOST:-}
      DD_ENV: ${DEPLOYMENT_ENV:-production}
      DD_SERVICE: arda
      DD_VERSION: "1.0.0"
      # Application Config
      LOG_LEVEL: ${LOG_LEVEL:-info}
    env_file:
      - ./arda/dev.env
    networks:
      - sense-network
      - observability
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - arda-data:/data

  # ============================================
  # Beorn - Authentication & Identity Service
  # ============================================
  beorn:
    build:
      context: ./beorn
      dockerfile: Dockerfile
    container_name: beorn-flask
    restart: unless-stopped
    ports:
      - "5002:5002"
    environment:
      # OpenTelemetry Configuration
      OTEL_SERVICE_NAME: beorn
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:-production}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://159.56.4.94:4318
      OTEL_EXPORTER_OTLP_PROTOCOL: http/protobuf
      OTEL_TRACES_SAMPLER: parentbased_traceidratio
      OTEL_TRACES_SAMPLER_ARG: "0.1"
      # DataDog (optional dual export)
      DD_AGENT_HOST: ${DD_AGENT_HOST:-}
      DD_ENV: ${DEPLOYMENT_ENV:-production}
      DD_SERVICE: beorn
      DD_VERSION: "1.0.0"
      # Application Config
      LOG_LEVEL: ${LOG_LEVEL:-info}
      SENSE_BEORN_CONFIG: /beorn/beorn_app/test_config.py
    env_file:
      - ./beorn/.env
    networks:
      - sense-network
      - observability
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - beorn-data:/data

  # ============================================
  # Palantir - Data Aggregation Service
  # ============================================
  palantir:
    build:
      context: ./palantir
      dockerfile: Dockerfile
    container_name: palantir-flask
    restart: unless-stopped
    ports:
      - "5003:5003"
    environment:
      # OpenTelemetry Configuration
      OTEL_SERVICE_NAME: palantir
      OTEL_SERVICE_VERSION: "1.0.0"
      OTEL_DEPLOYMENT_ENV: ${DEPLOYMENT_ENV:-production}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://159.56.4.94:4318
      OTEL_EXPORTER_OTLP_PROTOCOL: http/protobuf
      OTEL_TRACES_SAMPLER: parentbased_traceidratio
      OTEL_TRACES_SAMPLER_ARG: "0.1"
      # DataDog (optional dual export)
      DD_AGENT_HOST: ${DD_AGENT_HOST:-}
      DD_ENV: ${DEPLOYMENT_ENV:-production}
      DD_SERVICE: palantir
      DD_VERSION: "1.0.0"
      # Application Config
      LOG_LEVEL: ${LOG_LEVEL:-info}
    env_file:
      - ./palantir/.env
    networks:
      - sense-network
      - observability
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    volumes:
      - palantir-data:/data

volumes:
  arda-data:
    driver: local
  beorn-data:
    driver: local
  palantir-data:
    driver: local
