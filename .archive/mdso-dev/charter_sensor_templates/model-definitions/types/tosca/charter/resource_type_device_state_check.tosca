"$schema"   = "http://cyaninc.com/json-schemas/tosca-lite-v1/definition-module#"
title       = "Device State Check"
package     = charter
version     = "1.0"
description = """
This document defines the resource that can be used for the onboarding of a device into
the Blue Planet system.
"""
authors     = [ "Matt Becker (mbecker@ciena.com)" ]

imports {

}

resourceTypes { 
    DeviceStateChecker {
        derivedFrom = tosca.resourceTypes.Root
        title = Device State Checker
        description = """
         - This resource performs a check to see if the list of devices provided 
         - are in BPO and with a valid communication state for it to provision/update
         - a service.
         """

        properties {
        
            resource_name {
                title = "Resource Name"
                description = "Resource Name"
                type = string
                optional = true
                updatable = false
            }

            devices {
                title = "Devices"
                description = "The devices"
                type = array
                optional = false
                updatable = false
                items.type = object
                items.properties: {
                    device_name {
                        title = "Device Name"
                        description = "Device Name"
                        type = string
                    }
                    
                    device_vendor {
                        title = "Device Vendor"
                        description = "Device Vendor"
                        type = string
                    }
                    
                    device_host {
                        title = "Device Host"
                        description = "Device Host"
                        type = string
                    }
                    device_fqdn {
                        title = "Device fqdn"
                        description = "Device fqdn"
                        type = string
                    }
                    device_role {
                        title = "Device role"
                        description = "Device role"
                        type = string
                    }

                    device_model {
                        title = "Device Model"
                        description = "The device model"
                        type = string
                        optional = true
                        updatable = true
                    }
                }
            }
            
            property_path {
                title = "Property Path"
                description = "JSON Path to the property to get device"
                type = string
                optional = true
                updatable = true
                default = "label"
            }
        
            device_state {
                title = "Device States"
                description = "The device states"
                type = array
                output = true
                items {
                    type = object
                    properties {
                        device {
                            title = "Device Name"
                            description = "Device Name"
                            type = string
                        }
                        
                        device_id {
                            title = "Device UUID"
                            description = "Device UUID"
                            type = string
                            optional = true
                        }

                        reachable_via {
                            title = "Reachable Via"
                            description = "Reachable Via"
                            type = string
                            optional = true
                        }

                        reachable_ip {
                            title = "Is Reachable"
                            description = "True if the device is IP reachable"
                            type = boolean
                            optional = true
                            default = true
                        }
                        
                        state {
                            title = "State"
                            description = """
                            Device state:
                             - AVAILABLE: Device is available from BPO (Communication is up)
                             - NOT_AVAILABLE: Device is in BPO, but the communication state is down
                             - NOT_ONBOARD: Device is not in BPO
                            """
                            type = string
                            enum = [
                                "AVAILABLE",
                                "NOT_AVAILABLE",
                                "NOT_ONBOARD",
                            ]
                        }

                        connectivity_checked {
                            title = "Connectivity Checked"
                            description = "FQDN, IP checked for connectivity"
                            type = array
                            optional = true
                        }
                    
                    }
                
                }
                
            }
            
            
    
        }

        requirements {
    
        }
    
        capabilities {
    
        }

    }
}

serviceTemplates {

    DeviceStateChecker {
        title = Device State Checker
        description = "Device state check"
        implements = charter.resourceTypes.DeviceStateChecker
        
        plans {

            activate {
                type = remote
                language = python
                path = "scripts.deviceconfiguration.deviceonboarder.DeviceStateChecker"
            }
        }
        
        output = {
          device_state = { getAttr = [ activate, device_state ] }
        }
    }
}
