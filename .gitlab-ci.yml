# GitLab CI/CD Pipeline for Correlation Station & Sense Apps
# Author: Derrick Golden
# Version: 1.0.0

stages:
  - test
  - build
  - deploy
  - validate

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  DOCKER_BUILDKIT: 1
  META_SERVER: "159.56.4.94"

# ============================================
# Test Stage
# ============================================

test:correlation-engine:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd seefa-om/correlation-engine
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v --cov=app --cov-report=term --cov-report=xml
    - echo "Test coverage:"
    - coverage report
  coverage: '/TOTAL.*\s+(\d+%)$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: seefa-om/correlation-engine/coverage.xml
  only:
    - branches
    - merge_requests

test:sense-apps:beorn:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd sense-apps/beorn
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v --cov=beorn_app
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - branches
    - merge_requests

test:sense-apps:palantir:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd sense-apps/palantir
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v --cov=palantir_app
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - branches
    - merge_requests

test:sense-apps:arda:
  stage: test
  image: python:3.11-slim
  before_script:
    - cd sense-apps/arda
    - pip install -r requirements.txt
  script:
    - pytest tests/ -v --cov=arda_app
  coverage: '/TOTAL.*\s+(\d+%)$/'
  only:
    - branches
    - merge_requests

lint:python:
  stage: test
  image: python:3.11-slim
  before_script:
    - pip install flake8 black isort
  script:
    - echo "Running flake8..."
    - flake8 seefa-om/correlation-engine/app --max-line-length=100 --ignore=E501,W503
    - flake8 sense-apps/*/app --max-line-length=100 --ignore=E501,W503
    - echo "Checking black formatting..."
    - black --check seefa-om/correlation-engine/app
    - black --check sense-apps/*/app
  allow_failure: true
  only:
    - branches
    - merge_requests

# ============================================
# Build Stage
# ============================================

build:correlation-engine:
  stage: build
  image: docker:24-git
  services:
    - docker:24-dind
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/correlation-engine:$CI_COMMIT_SHORT_SHA
    IMAGE_LATEST: $CI_REGISTRY_IMAGE/correlation-engine:latest
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - cd seefa-om/correlation-engine
    - docker build
        --build-arg BUILDKIT_INLINE_CACHE=1
        --cache-from $IMAGE_LATEST
        --tag $IMAGE_TAG
        --tag $IMAGE_LATEST
        .
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
  only:
    - main
    - develop

build:sense-apps:
  stage: build
  image: docker:24-git
  services:
    - docker:24-dind
  parallel:
    matrix:
      - APP: beorn
      - APP: palantir
      - APP: arda
  variables:
    IMAGE_TAG: $CI_REGISTRY_IMAGE/sense-$APP:$CI_COMMIT_SHORT_SHA
    IMAGE_LATEST: $CI_REGISTRY_IMAGE/sense-$APP:latest
  before_script:
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY
  script:
    - cd sense-apps/$APP
    - docker build
        --build-arg BUILDKIT_INLINE_CACHE=1
        --cache-from $IMAGE_LATEST
        --tag $IMAGE_TAG
        --tag $IMAGE_LATEST
        .
    - docker push $IMAGE_TAG
    - docker push $IMAGE_LATEST
  only:
    - main
    - develop

# ============================================
# Deploy Stage
# ============================================

deploy:meta-server:staging:
  stage: deploy
  image: docker/compose:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $META_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to Meta server..."
    - ssh root@$META_SERVER "
        cd /opt/correlation-station/seefa-om &&
        docker-compose pull &&
        docker-compose up -d &&
        docker-compose ps
      "
    - echo "Deployment complete!"
  environment:
    name: staging
    url: http://$META_SERVER:8443
  only:
    - develop
  when: manual

deploy:meta-server:production:
  stage: deploy
  image: docker/compose:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $META_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Deploying to Production..."
    - ssh root@$META_SERVER "
        cd /opt/correlation-station/seefa-om &&
        docker-compose pull &&
        docker-compose up -d &&
        docker-compose ps
      "
    - echo "Production deployment complete!"
  environment:
    name: production
    url: http://$META_SERVER:8443
  only:
    - main
  when: manual

# ============================================
# Validation Stage
# ============================================

validate:health-checks:
  stage: validate
  image: curlimages/curl:latest
  script:
    - echo "Checking Correlation Engine health..."
    - curl -f http://$META_SERVER:8080/health || exit 1
    - echo "Checking Grafana health..."
    - curl -f http://$META_SERVER:8443/api/health || exit 1
    - echo "Checking Loki health..."
    - curl -f http://$META_SERVER:3100/ready || exit 1
    - echo "Checking Tempo health..."
    - curl -f http://$META_SERVER:3200/ready || exit 1
    - echo "All health checks passed!"
  only:
    - main
    - develop
  needs:
    - deploy:meta-server:staging
  when: on_success

validate:metrics:
  stage: validate
  image: curlimages/curl:latest
  script:
    - echo "Checking Correlation Engine metrics..."
    - curl -s http://$META_SERVER:8080/metrics | grep -q "correlation_events_total"
    - echo "Metrics validation passed!"
  only:
    - main
    - develop
  needs:
    - deploy:meta-server:staging
  when: on_success
  allow_failure: true

# ============================================
# Notification (optional)
# ============================================

notify:slack:
  stage: .post
  image: curlimages/curl:latest
  script:
    - |
      if [ "$CI_JOB_STATUS" == "success" ]; then
        MESSAGE="✅ Pipeline succeeded for $CI_PROJECT_NAME ($CI_COMMIT_REF_NAME)"
        COLOR="good"
      else
        MESSAGE="❌ Pipeline failed for $CI_PROJECT_NAME ($CI_COMMIT_REF_NAME)"
        COLOR="danger"
      fi
    - |
      curl -X POST "$SLACK_WEBHOOK_URL" \
        -H "Content-Type: application/json" \
        -d "{
          \"attachments\": [{
            \"color\": \"$COLOR\",
            \"text\": \"$MESSAGE\",
            \"fields\": [
              {\"title\": \"Commit\", \"value\": \"$CI_COMMIT_SHORT_SHA\", \"short\": true},
              {\"title\": \"Author\", \"value\": \"$CI_COMMIT_AUTHOR\", \"short\": true}
            ]
          }]
        }"
  when: always
  only:
    - main
  allow_failure: true
